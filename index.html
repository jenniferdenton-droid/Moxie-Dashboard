<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Moxie Dashboard</title>
<style>
  :root {
    --primary: #4E8D99;
    --secondary: #EBBA95;
    --accent: #6D445E;
    --bg: #f4f6f8;
    --card-bg: #ffffff;
    --text: #2c3e50;
    --subtext: #7f8c8d;
    --border: #e0e0e0;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-hover: 0 6px 20px rgba(78,141,153,0.25);
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: white;
    border-bottom: 2px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 70px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-img {
    height: 36px;
    object-fit: contain;
  }

  .header-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: -0.3px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* SEARCH */
  .search-wrap {
    position: relative;
  }
  .search-wrap input {
    padding: 9px 16px 9px 38px;
    border: 1.5px solid var(--border);
    border-radius: 24px;
    font-size: 0.9rem;
    width: 240px;
    outline: none;
    transition: border-color 0.2s;
    background: var(--bg);
  }
  .search-wrap input:focus { border-color: var(--primary); background: white; }
  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--subtext);
    font-size: 0.85rem;
  }

  /* BUTTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    border-radius: 24px;
    border: none;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  .btn-primary:hover { background: #3d7480; transform: translateY(-1px); }

  .btn-secondary {
    background: white;
    color: var(--accent);
    border: 1.5px solid var(--accent);
  }
  .btn-secondary:hover { background: var(--accent); color: white; }

  .btn-ghost {
    background: transparent;
    color: var(--subtext);
    border: 1.5px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

  .btn-sm {
    padding: 5px 10px;
    font-size: 0.78rem;
    border-radius: 8px;
  }

  /* MAIN */
  main {
    max-width: 1300px;
    margin: 0 auto;
    padding: 28px 24px;
  }

  /* CATEGORY SECTION */
  .category-section {
    margin-bottom: 36px;
  }

  .category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
  }

  .category-title-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .category-emoji { font-size: 1.3rem; }

  .category-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
  }

  .category-count {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2px 9px;
    font-size: 0.78rem;
    color: var(--subtext);
    font-weight: 600;
  }

  .category-actions {
    display: flex;
    gap: 6px;
  }

  /* GRID */
  .app-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 14px;
    min-height: 80px;
    padding: 8px;
    border-radius: var(--radius);
    transition: background 0.2s;
  }

  .app-grid.drag-over {
    background: rgba(78,141,153,0.08);
    border: 2px dashed var(--primary);
  }

  /* APP CARD */
  .app-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    padding: 18px 12px 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    cursor: grab;
    transition: all 0.2s;
    position: relative;
    text-decoration: none;
    color: inherit;
    user-select: none;
  }

  .app-card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-3px);
    border-color: var(--primary);
  }

  .app-card.dragging {
    opacity: 0.4;
    cursor: grabbing;
    transform: scale(0.95);
  }

  .app-card-actions {
    position: absolute;
    top: 6px;
    right: 6px;
    display: none;
    gap: 4px;
  }

  .app-card:hover .app-card-actions {
    display: flex;
  }

  .card-action-btn {
    background: white;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 6px;
    cursor: pointer;
    font-size: 0.72rem;
    color: var(--subtext);
    transition: all 0.15s;
    line-height: 1.4;
  }
  .card-action-btn:hover { border-color: var(--primary); color: var(--primary); }
  .card-action-btn.delete:hover { border-color: #e74c3c; color: #e74c3c; }

  .app-icon-wrap {
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg);
  }

  .app-icon-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .app-icon-wrap .emoji-icon {
    font-size: 2rem;
  }

  .app-name {
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
    color: var(--text);
    line-height: 1.3;
    word-break: break-word;
  }

  /* EMPTY STATE */
  .empty-drop {
    grid-column: 1/-1;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 70px;
    color: var(--subtext);
    font-size: 0.85rem;
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    opacity: 0.6;
  }

  /* MODAL OVERLAY */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(3px);
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: white;
    border-radius: 18px;
    padding: 32px;
    width: 460px;
    max-width: 95vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    position: relative;
    animation: modalIn 0.22s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.93) translateY(-12px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-close {
    position: absolute;
    top: 14px; right: 18px;
    background: none;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: var(--subtext);
    line-height: 1;
  }
  .modal-close:hover { color: var(--text); }

  .modal h2 {
    font-size: 1.2rem;
    margin-bottom: 22px;
    color: var(--text);
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 0.84rem;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text);
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
    background: var(--bg);
    color: var(--text);
  }
  .form-group input:focus,
  .form-group select:focus { border-color: var(--primary); background: white; }

  .icon-preview-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
  }

  .icon-preview {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: var(--bg);
    border: 1.5px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    font-size: 1.6rem;
  }

  .icon-preview img { width: 100%; height: 100%; object-fit: contain; }

  .icon-hint {
    font-size: 0.78rem;
    color: var(--subtext);
    line-height: 1.5;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  /* TOAST */
  #toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--text);
    color: white;
    padding: 12px 22px;
    border-radius: 10px;
    font-size: 0.88rem;
    font-weight: 500;
    z-index: 9999;
    opacity: 0;
    transform: translateY(12px);
    transition: all 0.3s;
    pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.success { background: var(--primary); }
  #toast.error { background: #e74c3c; }

  /* CATEGORY MODAL */
  #addCategoryModal .modal { width: 380px; }

  /* DRAG PLACEHOLDER */
  .drag-placeholder {
    border: 2px dashed var(--primary);
    border-radius: var(--radius);
    background: rgba(78,141,153,0.06);
    min-height: 120px;
  }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    header { padding: 0 16px; height: auto; flex-wrap: wrap; gap: 10px; padding: 12px 16px; }
    .search-wrap input { width: 180px; }
    .header-title { font-size: 1.1rem; }
    main { padding: 16px 12px; }
    .app-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Moxie_logo.svg/320px-Moxie_logo.svg.png"
         alt="Moxie Logo"
         class="logo-img"
         onerror="this.style.display='none'">
    <span class="header-title">Moxie Dashboard</span>
  </div>
  <div class="header-right">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Search apps..." oninput="filterApps(this.value)">
    </div>
    <button class="btn btn-primary" onclick="openAddModal()">ï¼‹ Add App</button>
    <button class="btn btn-secondary" onclick="openAddCategoryModal()">ï¼‹ Category</button>
    <button class="btn btn-ghost" onclick="exportData()" title="Export your dashboard">â†“ Export</button>
    <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()" title="Import dashboard">â†‘ Import</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
  </div>
</header>

<!-- MAIN -->
<main id="mainContent"></main>

<!-- ADD/EDIT APP MODAL -->
<div class="modal-overlay" id="appModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('appModal')">Ã—</button>
    <h2 id="modalTitle">Add New App</h2>

    <div class="form-group">
      <label>App Name *</label>
      <input type="text" id="appName" placeholder="e.g. Notion" />
    </div>

    <div class="form-group">
      <label>URL *</label>
      <input type="url" id="appUrl" placeholder="https://..." />
    </div>

    <div class="form-group">
      <label>Category</label>
      <select id="appCategory"></select>
    </div>

    <div class="form-group">
      <label>Icon</label>
      <input type="text" id="appIcon"
             placeholder="Emoji (ğŸš€) or paste image URL or base64"
             oninput="previewIcon(this.value)" />
      <div class="icon-preview-row">
        <div class="icon-preview" id="iconPreview"><span>ğŸŒ</span></div>
        <div class="icon-hint">
          Paste an emoji, an image URL, or upload:<br>
          <label style="color:var(--primary);cursor:pointer;font-weight:600;">
            Browse file
            <input type="file" id="iconFileInput" accept="image/*"
                   style="display:none" onchange="handleIconFile(this)">
          </label>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('appModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveApp()">Save App</button>
    </div>
  </div>
</div>

<!-- ADD CATEGORY MODAL -->
<div class="modal-overlay" id="addCategoryModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addCategoryModal')">Ã—</button>
    <h2>Add New Category</h2>
    <div class="form-group">
      <label>Category Name *</label>
      <input type="text" id="newCategoryName" placeholder="e.g. Design Tools" />
    </div>
    <div class="form-group">
      <label>Emoji Icon</label>
      <input type="text" id="newCategoryEmoji" placeholder="e.g. ğŸ¨" maxlength="4" />
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('addCategoryModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCategory()">Add Category</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DEFAULT DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CATEGORIES = [
  { id: 'communication', name: 'Communication', emoji: 'ğŸ“¬' },
  { id: 'project',       name: 'Project Management', emoji: 'ğŸ“‹' },
  { id: 'finance',       name: 'Finance', emoji: '' },
  { id: 'sales',         name: 'Sales & CRM', emoji: '' },
  { id: 'operations',    name: 'Operations', emoji: '' },
  { id: 'ai',            name: 'AI Tools', emoji: 'ğŸ¤–' },
];

const DEFAULT_APPS = [
  // Communication
  { id: 'gmail',     name: 'Gmail',          url: 'https://mail.google.com',           icon: 'https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico',                          category: 'communication' },
  { id: 'gmeet',     name: 'Google Meet',    url: 'https://meet.google.com',           icon: 'https://fonts.gstatic.com/s/i/productlogos/meet_2020q4/v1/web-512dp/logo_meet_2020q4_color_2x_web_512dp.png', category: 'communication' },
  { id: 'slack',     name: 'Slack',          url: 'https://slack.com',                 icon: 'https://a.slack-edge.com/80588/marketing/img/icons/icon_slack_hash_colored.png',   category: 'communication' },
  { id: 'loom',      name: 'Loom',           url: 'https://www.loom.com',              icon: 'https://cdn.loom.com/assets/favicons/favicon.ico',                                 category: 'communication' },
  { id: 'fathom',    name: 'Fathom',         url: 'https://fathom.video/home',         icon: 'https://fathom.video/favicon.ico',                                                 category: 'communication' },

  // Project Management
  { id: 'asana',     name: 'Asana',          url: 'https://app.asana.com/1/1203386861136560/home', icon: 'https://assets.asana.biz/m/245ce5b3f2045ede/original/asana-icon-2x.png', category: 'project' },
  { id: 'notion',    name: 'Notion',         url: 'https://www.notion.so/moxie-docs/6060ef49fea04dc3a1dc0a32d0564233', icon: 'https://www.notion.so/images/favicon.ico',        category: 'project' },
  { id: 'arrows',    name: 'Arrows',         url: 'https://success.joinmoxie.com/home', icon: 'https://www.joinmoxie.com/favicon.ico',                                            category: 'project' },

  // Finance
  { id: 'ramp',      name: 'Ramp',           url: 'https://app.ramp.com/sign-in',      icon: 'https://ramp.com/favicon.ico',                                                     category: 'finance' },
  { id: 'stripe',    name: 'Stripe',         url: 'https://dashboard.stripe.com/register?account_invite=uis_sSEYJeeK7OA10mzCAF69eIyxWICgGRPI', icon: 'https://stripe.com/favicon.ico', category: 'finance' },
  { id: 'justworks', name: 'JustWorks',      url: 'https://payroll.justworks.com/account/vouchers', icon: 'https://justworks.com/favicon.ico',                                    category: 'finance' },

  // Sales & CRM
  { id: 'hubspot',   name: 'HubSpot',        url: 'https://app.hubspot.com/login/?loginRedirectUrl=https%3A%2F%2Fapp.hubspot.com%2Fcont', icon: 'https://www.hubspot.com/favicon.ico', category: 'sales' },
  { id: 'shopify',   name: 'Shopify',        url: 'https://admin.shopify.com/store/moxie-9681', icon: 'https://cdn.shopify.com/shopifycloud/shopify/assets/shopify_favicon-7f5c5352d7c3568e5fe49f0c81cf0e6a5fcd02cd5b61eedc34acfe2ca31a4bca.png', category: 'sales' },

  // Operations
  { id: 'omni',      name: 'Omni',           url: 'https://moxie.omniapp.co',          icon: 'https://moxie.omniapp.co/favicon.ico',                                             category: 'operations' },
  { id: 'glean',     name: 'Glean',          url: 'https://app.glean.com/?qe=https%3A%2F%2Fjoinmoxie-be.glean.com', icon: 'https://app.glean.com/favicon.ico',                  category: 'operations' },
  { id: 'zapier',    name: 'Zapier',         url: 'https://zapier.com',                icon: 'https://cdn.zapier.com/storage/photos/9ec65c79de8ae54080e8e7f9a9e5f020.png',        category: 'operations' },
  { id: '1password', name: '1Password',      url: 'https://my.1password.com',          icon: 'https://1password.com/favicon.ico',                                                category: 'operations' },
  { id: 'dropbox',   name: 'Dropbox Sign',   url: 'https://app.hellosign.com/account/logIn', icon: 'https://app.hellosign.com/favicon.ico',                                      category: 'operations' },
  { id: 'gcal',      name: 'Google Calendar',url: 'https://calendar.google.com',       icon: 'https://calendar.google.com/googlecalendar/images/favicon_v2014_1.ico',            category: 'operations' },
  { id: 'gsheets',   name: 'Google Sheets',  url: 'https://sheets.google.com',         icon: 'https://ssl.gstatic.com/docs/spreadsheets/favicon3.ico',                           category: 'operations' },
  { id: 'moxieadmin',name: 'Moxie Admin',    url: 'https://api.prod.internal.joinmoxie.com/admin/login/', icon: '',                                                            category: 'operations' },
  { id: 'github',    name: 'GitHub',         url: 'https://github.com',                icon: 'https://github.com/favicon.ico',                                                   category: 'operations' },

  // AI
  { id: 'chatgpt',   name: 'ChatGPT',        url: 'https://chatgpt.com',               icon: 'https://chatgpt.com/favicon.ico',                                                  category: 'ai' },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = { categories: [], apps: [] };
let editingAppId = null;
let dragSrcId = null;
let dragSrcCategory = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const saved = localStorage.getItem('moxieDashboard');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // Merge: keep saved data but add any new defaults not yet present
      state.categories = parsed.categories || DEFAULT_CATEGORIES;
      const savedIds = new Set((parsed.apps || []).map(a => a.id));
      const newDefaults = DEFAULT_APPS.filter(a => !savedIds.has(a.id));
      state.apps = [...(parsed.apps || []), ...newDefaults];
    } catch(e) {
      state = { categories: [...DEFAULT_CATEGORIES], apps: [...DEFAULT_APPS] };
    }
  } else {
    state = { categories: [...DEFAULT_CATEGORIES], apps: [...DEFAULT_APPS] };
  }
  render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SAVE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() {
  localStorage.setItem('moxieDashboard', JSON.stringify(state));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(filter = '') {
  const main = document.getElementById('mainContent');
  main.innerHTML = '';

  state.categories.forEach(cat => {
    let apps = state.apps.filter(a => a.category === cat.id);
    if (filter) {
      apps = apps.filter(a => a.name.toLowerCase().includes(filter.toLowerCase()));
    }

    const section = document.createElement('div');
    section.className = 'category-section';
    section.dataset.categoryId = cat.id;

    section.innerHTML = `
      <div class="category-header">
        <div class="category-title-wrap">
          <span class="category-emoji">${cat.emoji || 'ğŸ“'}</span>
          <span class="category-name">${cat.name}</span>
          <span class="category-count">${apps.length}</span>
        </div>
        <div class="category-actions">
          <button class="btn btn-ghost btn-sm" onclick="renameCategory('${cat.id}')">âœï¸ Rename</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteCategory('${cat.id}')">ğŸ—‘ï¸ Remove</button>
        </div>
      </div>
      <div class="app-grid" id="grid-${cat.id}"
           ondragover="onDragOver(event,'${cat.id}')"
           ondragleave="onDragLeave(event,'${cat.id}')"
           ondrop="onDrop(event,'${cat.id}')">
        ${apps.length === 0 ? '<div class="empty-drop">Drop apps here</div>' : ''}
        ${apps.map(app => renderAppCard(app)).join('')}
      </div>
    `;

    main.appendChild(section);
  });
}

function renderAppCard(app) {
  const iconHtml = isEmoji(app.icon)
    ? `<span class="emoji-icon">${app.icon}</span>`
    : `<img src="${app.icon}" alt="${app.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ğŸŒ</text></svg>'">`;

  return `
    <div class="app-card"
         draggable="true"
         data-app-id="${app.id}"
         ondragstart="onDragStart(event,'${app.id}','${app.category}')"
         ondragend="onDragEnd(event)"
         onclick="handleCardClick(event,'${app.url}')">
      <div class="app-card-actions">
        <button class="card-action-btn" onclick="editApp('${app.id}')" title="Edit">âœï¸</button>
        <button class="card-action-btn delete" onclick="deleteApp('${app.id}')" title="Delete">âœ•</button>
      </div>
      <div class="app-icon-wrap">${iconHtml}</div>
      <span class="app-name">${app.name}</span>
    </div>
  `;
}

function isEmoji(str) {
  if (!str) return false;
  // Check if it's NOT a URL and NOT base64
  return !str.startsWith('http') && !str.startsWith('data:') && !str.startsWith('/');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CARD CLICK (ignore if clicking action btn)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleCardClick(e, url) {
  if (e.target.closest('.app-card-actions')) return;
  window.open(url, '_blank');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SEARCH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterApps(val) { render(val); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DRAG & DROP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e, appId, catId) {
  dragSrcId = appId;
  dragSrcCategory = catId;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.app-grid').forEach(g => g.classList.remove('drag-over'));
}

function onDragOver(e, catId) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  document.getElementById('grid-' + catId).classList.add('drag-over');
}

function onDragLeave(e, catId) {
  document.getElementById('grid-' + catId).classList.remove('drag-over');
}

function onDrop(e, catId) {
  e.preventDefault();
  document.getElementById('grid-' + catId).classList.remove('drag-over');
  if (!dragSrcId || dragSrcId === catId) return;

  const app = state.apps.find(a => a.id === dragSrcId);
  if (app) {
    app.category = catId;
    save();
    render(document.getElementById('searchInput').value);
    showToast(`Moved "${app.name}" to ${state.categories.find(c=>c.id===catId)?.name}`, 'success');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADD / EDIT APP MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal() {
  editingAppId = null;
  document.getElementById('modalTitle').textContent = 'Add New App';
  document.getElementById('appName').value = '';
  document.getElementById('appUrl').value = '';
  document.getElementById('appIcon').value = '';
  previewIcon('');
  populateCategorySelect();
  openModal('appModal');
}

function editApp(appId) {
  const app = state.apps.find(a => a.id === appId);
  if (!app) return;
  editingAppId = appId;
  document.getElementById('modalTitle').textContent = 'Edit App';
  document.getElementById('appName').value = app.name;
  document.getElementById('appUrl').value = app.url;
  document.getElementById('appIcon').value = app.icon || '';
  previewIcon(app.icon || '');
  populateCategorySelect(app.category);
  openModal('appModal');
}

function populateCategorySelect(selected = '') {
  const sel = document.getElementById('appCategory');
  sel.innerHTML = state.categories.map(c =>
    `<option value="${c.id}" ${c.id === selected ? 'selected' : ''}>${c.emoji} ${c.name}</option>`
  ).join('');
}

function saveApp() {
  const name = document.getElementById('appName').value.trim();
  const url  = document.getElementById('appUrl').value.trim();
  const icon = document.getElementById('appIcon').value.trim();
  const cat  = document.getElementById('appCategory').value;

  if (!name) { showToast('Please enter an app name', 'error'); return; }
  if (!url)  { showToast('Please enter a URL', 'error'); return; }

  if (editingAppId) {
    const app = state.apps.find(a => a.id === editingAppId);
    if (app) { app.name = name; app.url = url; app.icon = icon || 'ğŸŒ'; app.category = cat; }
    showToast(`"${name}" updated!`, 'success');
  } else {
    const id = 'app_' + Date.now();
    state.apps.push({ id, name, url, icon: icon || 'ğŸŒ', category: cat });
    showToast(`"${name}" added!`, 'success');
  }

  save();
  closeModal('appModal');
  render(document.getElementById('searchInput').value);
}

function deleteApp(appId) {
  const app = state.apps.find(a => a.id === appId);
  if (!app) return;
  if (!confirm(`Remove "${app.name}"?`)) return;
  state.apps = state.apps.filter(a => a.id !== appId);
  save();
  render(document.getElementById('searchInput').value);
  showToast(`"${app.name}" removed`, 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ICON PREVIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewIcon(val) {
  const prev = document.getElementById('iconPreview');
  if (!val) { prev.innerHTML = '<span>ğŸŒ</span>'; return; }
  if (isEmoji(val)) {
    prev.innerHTML = `<span style="font-size:1.8rem">${val}</span>`;
  } else {
    prev.innerHTML = `<img src="${val}" style="width:100%;height:100%;object-fit:contain" onerror="this.parentElement.innerHTML='<span>ğŸŒ</span>'">`;
  }
}

function handleIconFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('appIcon').value = e.target.result;
    previewIcon(e.target.result);
  };
  reader.readAsDataURL(file);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CATEGORIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddCategoryModal() {
  document.getElementById('newCategoryName').value = '';
  document.getElementById('newCategoryEmoji').value = '';
  openModal('addCategoryModal');
}

function saveCategory() {
  const name  = document.getElementById('newCategoryName').value.trim();
  const emoji = document.getElementById('newCategoryEmoji').value.trim() || 'ğŸ“';
  if (!name) { showToast('Please enter a category name', 'error'); return; }

  const id = 'cat_' + Date.now();
  state.categories.push({ id, name, emoji });
  save();
  closeModal('addCategoryModal');
  render(document.getElementById('searchInput').value);
  showToast(`Category "${name}" added!`, 'success');
}

function renameCategory(catId) {
  const cat = state.categories.find(c => c.id === catId);
  if (!cat) return;
  const newName = prompt('Rename category:', cat.name);
  if (newName && newName.trim()) {
    cat.name = newName.trim();
    const newEmoji = prompt('Change emoji (optional):', cat.emoji);
    if (newEmoji !== null) cat.emoji = newEmoji.trim() || cat.emoji;
    save();
    render(document.getElementById('searchInput').value);
    showToast('Category updated!', 'success');
  }
}

function deleteCategory(catId) {
  const cat = state.categories.find(c => c.id === catId);
  const appCount = state.apps.filter(a => a.category === catId).length;
  if (!confirm(`Delete category "${cat?.name}"? ${appCount > 0 ? `${appCount} app(s) will be moved to the first category.` : ''}`)) return;

  state.categories = state.categories.filter(c => c.id !== catId);
  if (state.categories.length > 0) {
    state.apps.forEach(a => { if (a.category === catId) a.category = state.categories[0].id; });
  }
  save();
  render(document.getElementById('searchInput').value);
  showToast('Category removed', 'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EXPORT / IMPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'moxie-dashboard-backup.json';
  a.click();
  showToast('Dashboard exported!', 'success');
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.categories && data.apps) {
        state = data;
        save();
        render();
        showToast('Dashboard imported!', 'success');
      } else {
        showToast('Invalid file format', 'error');
      }
    } catch { showToast('Could not read file', 'error'); }
  };
  reader.readAsText(file);
  input.value = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimeout;
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `show ${type}`;
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => { t.className = ''; }, 3000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  START
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>

